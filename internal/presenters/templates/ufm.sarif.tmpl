{{define "main" }}
	{
		"$schema": "https://docs.oasis-open.org/sarif/sarif/v2.1.0/errata01/os/schemas/sarif-schema-2.1.0.json",
		"version": "2.1.0",
		"runs": [
		{{- range $resultIndex, $result := $.TestResults}}
			{{- $findingTypes := getFindingTypesFromTestResult $result }}
			{{- $findingType := index $findingTypes 0 }}
			{{- $issues := getIssuesFromTestResult $result }}
			{{- $issuesSize := sub (len $issues) 1 }}
			{{- $metadata := $result.GetMetadata }}
			{
				"tool": {
					"driver" : {
						"name" : "{{- convertTypeToDriverName (printf "%s" $findingType) }}",
						"semanticVersion" : "{{- getRuntimeInfo "version" }}",
						"version" : "{{- getRuntimeInfo "version" }}",
						"informationUri" : "https://docs.snyk.io/",
						"rules" : [
							{{- range $index, $issue := $issues }}
							{{- $tags := buildRuleTags $issue }}
							{{- $cvssScore := getRuleCVSSScore $issue }}
							{{- $problemID := $issue.GetProblemID }}
							{{- if not $problemID }}{{ $problemID = $issue.GetID }}{{ end }}
							{
								"id": {{ getQuotedString $problemID }},
								"shortDescription": {
									"text": {{ getQuotedString (buildRuleShortDescription $issue) }}
								},
								{{- with buildRuleFullDescription $issue }}
								"fullDescription": {
									"text": {{ getQuotedString . }}
								},
								{{- end }}
								"help": {
									"text": "",
									"markdown": {{ getQuotedString (buildRuleHelpMarkdown $issue $issue.GetFindingType) }}
								},
								"properties": {
									"tags": [
										{{- $tagsSize := sub (len $tags) 1 }}
										{{- range $tagIndex, $tag := $tags }}
										{{ getQuotedString (printf "%v" $tag) }}{{if lt $tagIndex $tagsSize}},{{end}}
										{{- end }}
									]{{if ge $cvssScore 0.0}},
									"cvssv3_baseScore": {{ $cvssScore }},
									"security-severity": {{ getQuotedString (printf "%.1f" $cvssScore) }}{{end}}
								}
							}{{if lt $index $issuesSize}},{{end}}
							{{- end }}
						]
						{{- $dependencyCount := index $metadata "dependency-count" }}
						{{- if $dependencyCount }},
						"properties": {
							"artifactsScanned": {{ $dependencyCount }}
						}
						{{- end }}
					}
				},
			"results": [
				{{- $displayTargetFile := index $result.GetMetadata "display-target-file" }}
				{{- $targetFile := "" }}
				{{- if $displayTargetFile }} {{- $targetFile = $displayTargetFile }} {{- end }}
				{{- range $index, $issue := $issues }}
				{{- $locations := buildLocationsFromIssue $issue $targetFile }}
				{{- $location := "" }}
				{{- $physicalLoc := "" }}
				{{- $region := "" }}
				{{- $artifactLocation := "" }}
				{{- if $locations }}
				{{- $location = getElementAtIndex $locations 0 }}
				{{- $physicalLoc = index $location "physicalLocation" }}
				{{- if $physicalLoc }}
				{{- $region = index $physicalLoc "region" }}
				{{- $artifactLocation = index $physicalLoc "artifactLocation" }}
				{{- end }}
				{{- end }}
				{{- $fix := buildFixFromIssue $issue }}
				{{- $ignoreDetails := $issue.GetIgnoreDetails }}
				{{- $problemID := $issue.GetProblemID }}
				{{- if not $problemID }}{{ $problemID = $issue.GetID }}{{ end }}
				{
					"ruleId": {{ getQuotedString $problemID }},
					"level": {{ getQuotedString (severityToSarifLevel $issue.GetSeverity) }},
					"message": {
						"text": {{ getQuotedString (formatIssueMessage $issue) }}
					}
					{{- if $locations }},
					"locations": [
						{{- $locationsSize := sub (len $locations) 1 }}
						{{- range $locIndex, $loc := $locations }}
						{
							{{- $physicalLoc := index $loc "physicalLocation" }}
							{{- $logicalLocs := index $loc "logicalLocations" }}
							{{- $region := index $physicalLoc "region" }}
							{{- $artifactLocation := index $physicalLoc "artifactLocation" }}
							{{- if $physicalLoc }}
							"physicalLocation": {
								"artifactLocation": {
									"uri": {{ getQuotedString (index $artifactLocation "uri") }}
								},
								"region": {
									"startLine": {{ index $region "startLine" }}{{if index $region "startColumn"}},{{end}}
									{{- if index $region "startColumn" }}
									"startColumn": {{ index $region "startColumn" }}{{if index $region "endLine"}},{{end}}
									{{- end }}
									{{- if index $region "endLine" }}
									"endLine": {{ index $region "endLine" }}{{if index $region "endColumn"}},{{end}}
									{{- end }}
									{{- if index $region "endColumn" }}
									"endColumn": {{ index $region "endColumn" }}
									{{- end }}
								}
							}
							{{- end }}
							{{- if and $physicalLoc $logicalLocs}} , {{end}}
							{{- if $logicalLocs }}
							"logicalLocations": [
								{{- $logicalLocsSize := sub (len $logicalLocs) 1 }}
								{{- range $logLocIndex, $logLoc := $logicalLocs }}
								{
									"fullyQualifiedName": {{ getQuotedString (index $logLoc "fullyQualifiedName") }}
								}{{if lt $logLocIndex $logicalLocsSize}},{{end}}
								{{- end }}
							]
							{{- end }}
						}{{if lt $locIndex $locationsSize}},{{end}}
						{{- end }}
						{{- end }}
					]
					{{- if $fix }},
					"fixes": [
						{
							"description": {
								"text": {{ getQuotedString (index $fix "description") }}
							},
							"artifactChanges": [
								{
									{{- if $artifactLocation }}
									"artifactLocation": {
										"uri": {{ getQuotedString (index $artifactLocation "uri") }}
									},
									{{- end }}
									"replacements": [
										{
											{{- if $region }}
											"deletedRegion": {
												"startLine": {{ index $region "startLine" }}
											},
											{{- end }}
											"insertedContent": {
												"text": {{ getQuotedString (index $fix "packageVersion") }}
											}
										}
									]
								}
							]
						}
					]
					{{- end }}
					{{- if $ignoreDetails }},
					"suppressions": [
						{
							{{- $policyID := $ignoreDetails.GetPolicyID }}
							{{- if $policyID }}
							"guid": {{ getQuotedString $policyID }},
							{{- end }}
							{{- $status := printf "%s" $ignoreDetails.GetStatus }}
							{{- if eq $status "ignored" }}
							"status": "accepted"
							{{- else if eq $status "pending_ignore_approval" }}
							"status": "underReview"
							{{- else if eq $status "other" }}
							"status": "rejected"
							{{- else }}
							"status": "accepted"
							{{- end }},
							{{- $justification := $ignoreDetails.GetJustification }}
							{{- if $justification }}
							"justification": {{ getQuotedString $justification }},
							{{- end }}
							"kind": "external"
							{{- $reasonType := $ignoreDetails.GetIgnoreReasonType }}
							{{- $createdAt := $ignoreDetails.GetCreatedAt }}
							{{- $expiresAt := $ignoreDetails.GetExpiresAt }}
							{{- $ignoredBy := $ignoreDetails.GetIgnoredBy }}
							{{- if or $reasonType $createdAt $expiresAt $ignoredBy }},
							"properties": {
								{{- if $reasonType }}
								"category": {{ getQuotedString $reasonType }}{{if or $expiresAt $createdAt $ignoredBy}},{{end}}
								{{- end }}
								{{- if $expiresAt }}
								"expiration": "{{ $expiresAt.Format "2006-01-02T15:04:05Z07:00" }}"{{if or $createdAt $ignoredBy}},{{end}}
								{{- end }}
								{{- if $createdAt }}
								"ignoredOn": "{{ $createdAt.Format "2006-01-02T15:04:05Z07:00" }}"{{if $ignoredBy}},{{end}}
								{{- end }}
								{{- if $ignoredBy }}
								"ignoredBy": {
									"name": {{ getQuotedString $ignoredBy.Name }},
									{{- if $ignoredBy.Email }}
									"email": {{ getQuotedString $ignoredBy.Email }}
									{{- else }}
									"email": ""
									{{- end }}
								}
								{{- end }}
							}
							{{- end }}
						}
					]
					{{- end }}
				}{{if lt $index $issuesSize}},{{end}}
				{{- end}}
			],
				{{- /* TODO: Add properties section for SAST (coverage) and upload results
				"properties": {
					"coverage": [
						{{- $coverageSize := sub (len $result.Summary.Coverage) 1 }}
						{{- range $coverageIndex, $coverage := $result.Summary.Coverage }}
						{
							"files": {{ $coverage.Files }},
							"isSupported": {{ $coverage.IsSupported }},
							"lang": "{{ $coverage.Lang }}",
							"type": "{{ $coverage.Type }}"
						}{{if lt $coverageIndex $coverageSize}},{{end}}
						{{- end }}
					]
					{{- if .Links.report }},
					"uploadResult": {
						"projectId": "{{ .Links.projectid }}",
						"snapshotId": "{{ .Links.snapshotid }}",
						"reportUrl": "{{ .Links.report }}"
					}
					{{- end }}
				},
				*/ -}}
				"automationDetails": {
					{{- $projectName := or (index $metadata "project-name") "" }}
					{{- if not $projectName }} {{- $projectName = printf "%d" $resultIndex }} {{- end }}
					"id": {{- getQuotedString (getAutomationDetailsId $projectName (printf "%s" $findingType)) }}
				}
			}{{if (lt $resultIndex (sub (len $.TestResults) 1))}},{{end}}{{- end}}
		]
	}
{{end }} {{/* end main */}}

{{template "main" . }}

{{define "main" }}
	{
		"$schema": "https://docs.oasis-open.org/sarif/sarif/v2.1.0/errata01/os/schemas/sarif-schema-2.1.0.json",
		"version": "2.1.0",
		"runs": [
		{{- range $resultIndex, $result := $.TestResults}}
			{{- $findingTypes := getFindingTypesFromTestResult $result }}
			{{- $findingTypesSize := sub (len $findingTypes) 1 }}
			{{- range $findingTypeIndex, $findingType := $findingTypes }}
			{{- $issues := getIssuesFromTestResult $result $findingType }}
			{{- $issuesSize := sub (len $issues) 1 }}
			{
				"tool": {
					"driver" : {
						"name" : "{{- convertTypeToDriverName (printf "%s" $findingType) }}",
						"semanticVersion" : "{{- getRuntimeInfo "version" }}",
						"version" : "{{- getRuntimeInfo "version" }}",
						"informationUri" : "https://docs.snyk.io/",
					"rules" : [
						{{- range $index, $issue := $issues }}
						{{- $tags := buildRuleTags $issue }}
						{{- $cvssScore := getRuleCVSSScore $issue }}
						{
							"id": {{ getQuotedString $issue.GetID }},
							"shortDescription": {
								"text": {{ getQuotedString (buildRuleShortDescription $issue) }}
							},
							"fullDescription": {
								"text": {{ getQuotedString (buildRuleFullDescription $issue) }}
							},
							"help": {
								"text": "",
								"markdown": {{ getQuotedString (buildRuleHelpMarkdown $issue $findingType) }}
							},
							"properties": {
								"tags": [
									{{- $tagsSize := sub (len $tags) 1 }}
									{{- range $tagIndex, $tag := $tags }}
									{{ getQuotedString (printf "%v" $tag) }}{{if lt $tagIndex $tagsSize}},{{end}}
									{{- end }}
								]{{if ge $cvssScore 0.0}},
								"cvssv3_baseScore": {{ $cvssScore }},
								"security-severity": {{ getQuotedString (printf "%.1f" $cvssScore) }}{{end}}
							}
						}{{if lt $index $issuesSize}},{{end}}
						{{- end }}
					]
					}
				},
			"results": [
				{{- $manifestPath := getManifestPath $result }}
				{{- range $index, $issue := $issues }}
				{{- $location := buildLocationFromIssue $issue }}
				{{- $fixes := buildFixesFromIssue $issue }}
				{{- $suppression := $issue.GetSuppression }}
				{
					"ruleId": {{ getQuotedString $issue.GetID }},
					"level": {{ getQuotedString (severityToSarifLevel $issue.GetSeverity) }},
					"message": {
						"text": {{ getQuotedString (formatIssueMessage $issue) }}
					},
					"locations": [
						{{- if $location }}
						{{- $physicalLoc := index $location "physicalLocation" }}
						{{- $region := index $physicalLoc "region" }}
						{{- $logicalLocs := index $location "logicalLocations" }}
						{
							"physicalLocation": {
								"artifactLocation": {
									"uri": {{ getQuotedString $manifestPath }}
								},
								"region": {
									"startLine": {{ index $region "startLine" }}
								}
							},
							"logicalLocations": [
								{{- range $logLoc := $logicalLocs }}
								{
									"fullyQualifiedName": {{ getQuotedString (index $logLoc "fullyQualifiedName") }}
								}
								{{- end }}
							]
						}
						{{- end }}
					]
					{{- if $fixes }},
					"fixes": [
						{{- $fixSize := sub (len $fixes) 1 }}
						{{- range $fixIndex, $fix := $fixes }}
						{
							"description": {
								"text": {{ getQuotedString (index (index $fix "description") "text") }}
							},
							"artifactChanges": [
								{{- $artifactChanges := index $fix "artifactChanges" }}
								{{- $changeSize := sub (len $artifactChanges) 1 }}
								{{- range $changeIndex, $change := $artifactChanges }}
								{
									"artifactLocation": {
										"uri": {{ getQuotedString $manifestPath }}
									},
									"replacements": [
										{{- $replacements := index $change "replacements" }}
										{{- $replaceSize := sub (len $replacements) 1 }}
										{{- range $replaceIndex, $replacement := $replacements }}
										{
											"deletedRegion": {
												"startLine": {{ index (index $replacement "deletedRegion") "startLine" }}
											},
											"insertedContent": {
												"text": {{ getQuotedString (index (index $replacement "insertedContent") "text") }}
											}
										}{{if lt $replaceIndex $replaceSize}},{{end}}
										{{- end }}
									]
								}{{if lt $changeIndex $changeSize}},{{end}}
								{{- end }}
							]
						}{{if lt $fixIndex $fixSize}},{{end}}
						{{- end }}
					]
					{{- end }}
					{{- if $suppression }},
					"suppressions": [
						{
							"kind": "external",
							{{- $status := printf "%s" $suppression.Status }}
							{{- if eq $status "accepted" }}
							"status": "accepted"
							{{- else if eq $status "under_review" }}
							"status": "underReview"
							{{- else if eq $status "rejected" }}
							"status": "rejected"
							{{- else }}
							"status": "accepted"
							{{- end }}
							{{- if $suppression.Justification }},
							"justification": {{ getQuotedString $suppression.Justification }}
							{{- end }}
						}
					]
					{{- end }}
				}{{if lt $index $issuesSize}},{{end}}
				{{- end}}
			],
				{{- /* TODO: Add properties section for SAST (coverage) and upload results
				"properties": {
					"coverage": [
						{{- $coverageSize := sub (len $result.Summary.Coverage) 1 }}
						{{- range $coverageIndex, $coverage := $result.Summary.Coverage }}
						{
							"files": {{ $coverage.Files }},
							"isSupported": {{ $coverage.IsSupported }},
							"lang": "{{ $coverage.Lang }}",
							"type": "{{ $coverage.Type }}"
						}{{if lt $coverageIndex $coverageSize}},{{end}}
						{{- end }}
					]
					{{- if .Links.report }},
					"uploadResult": {
						"projectId": "{{ .Links.projectid }}",
						"snapshotId": "{{ .Links.snapshotid }}",
						"reportUrl": "{{ .Links.report }}"
					}
					{{- end }}
				},
				*/ -}}
				"automationDetails": {
					"id": "{{- getAutomationDetailsId (getValueFromConfig "project-name") (printf "%s" $findingType) }}"
				}
			}{{if lt $findingTypeIndex $findingTypesSize}},{{end}}{{- end}}	
		{{- end}}
		]
	}
{{end }} {{/* end main */}}

{{template "main" . }}

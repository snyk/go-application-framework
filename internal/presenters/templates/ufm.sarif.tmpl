{{define "main" }}
	{
		"$schema": "https://docs.oasis-open.org/sarif/sarif/v2.1.0/errata01/os/schemas/sarif-schema-2.1.0.json",
		"version": "2.1.0",
		"runs": [
		{{- range $resultIndex, $result := $.TestResults}}
			{{- $findingTypes := getFindingTypesFromTestResult $result }}
			{{- $findingTypesSize := sub (len $findingTypes) 1 }}
			{{- range $findingTypeIndex, $findingType := $findingTypes }}
			{
				"tool": {
					"driver" : {
						"name" : "{{- convertTypeToDriverName (printf "%s" $findingType) }}",
						"semanticVersion" : "{{- getRuntimeInfo "version" }}",
						"version" : "{{- getRuntimeInfo "version" }}",
						"informationUri" : "https://docs.snyk.io/",
						"rules" : [
							{{- $rules := getRulesFromTestResult $result $findingType }}
							{{- $rulesSize := sub (len $rules) 1 }}
							{{- range $index, $rule := $rules }}
							{
								"id": {{ getQuotedString (index $rule "id") }},
								"shortDescription": {
									"text": {{ getQuotedString (index $rule "shortDescription") }}
								},
								"fullDescription": {
									"text": {{ getQuotedString (index $rule "fullDescription") }}
								},
								"help": {
									"text": {{ getQuotedString (index $rule "help_text") }},
									"markdown": {{ getQuotedString (index $rule "help_markdown") }}
								},
								"properties": {
									{{- $props := index $rule "properties" }}
									{{- if $props }}
									"cvssv3_baseScore": {{ index $props "cvssv3_baseScore" }},
									"security-severity": {{ getQuotedString (index $props "security-severity") }}
									{{- end }}
								}
							{{- /* OLD COMMENTED PROPERTIES:
							"properties": {
								"tags": [
									{{- $tagsSize := sub (len $rule.Properties.Tags) 1 }}
									{{- range $tagIndex, $tag := $rule.Properties.Tags }}
									{{ getQuotedString $tag }}{{if lt $tagIndex $tagsSize}},{{end}}
									{{- end }}
								],
								"categories": [
									{{- $categoriesSize := sub (len $rule.Properties.Categories) 1 }}
									{{- range $catIndex, $category := $rule.Properties.Categories }}
									{{ getQuotedString $category }}{{if lt $catIndex $categoriesSize}},{{end}}
									{{- end }}
								],
								"exampleCommitFixes": [
									{{- $examplesSize := sub (len $rule.Properties.ExampleCommitFixes) 1 }}
									{{- range $exampleIndex, $example := $rule.Properties.ExampleCommitFixes }}
									{

										"commitURL": "{{ $example.CommitUrl }}",
										"lines": [
											{{- $lineSize := sub (len $example.Lines) 1 }}
											{{- range $lineIndex, $line := $example.Lines }}
											{
												"line": {{ getQuotedString $line.Line -}},
												"lineNumber": {{ $line.LineNumber }},
												"lineChange": "{{ $line.LineChange }}"
											}{{if lt $lineIndex $lineSize}},{{end}}
											{{- end }}
										]
									}{{if lt $exampleIndex $examplesSize}},{{end}}
									{{- end }}
								],
								"exampleCommitDescriptions": [
									{{- $examplesSize := sub (len $rule.Properties.ExampleCommitDescriptions) 1 }}
									{{- range $exampleIndex, $example := $rule.Properties.ExampleCommitDescriptions }}
									"{{ $example }}"{{if lt $exampleIndex $examplesSize}},{{end}}
									{{- end }}
								],
								"precision": "{{ $rule.Properties.Precision }}",
								"repoDatasetSize": {{ $rule.Properties.RepoDatasetSize }},
								"cwe": [
									{{- $cweSize := sub (len $rule.Properties.Cwe) 1 }}
									{{- range $cweIndex, $cwe := $rule.Properties.Cwe }}
									"{{ $cwe }}"{{if lt $cweIndex $cweSize}},{{end}}
									{{- end }}
								]
							} */ -}}
							}{{if lt $index $rulesSize}},{{end}}
							{{- end }}
						]
					}
				},
				"results": [
					{{- $results := getResultsFromTestResult $result $findingType }}
					{{- $resultsSize := sub (len $results) 1 }}
					{{- range $index, $sarifResult := $results }}
					{{- $message := index $sarifResult "message" }}
					{{- $locations := index $sarifResult "locations" }}
					{{- $fixes := index $sarifResult "fixes" }}
					{
						"ruleId": {{ getQuotedString (index $sarifResult "ruleId") }},
						"level": {{ getQuotedString (index $sarifResult "level") }},
						"message": {
							"text": {{ getQuotedString (index $message "text") }}
						},
						"locations": [
							{{- $locSize := sub (len $locations) 1 }}
							{{- range $locIndex, $location := $locations }}
							{{- $physicalLoc := index $location "physicalLocation" }}
							{{- $artifactLoc := index $physicalLoc "artifactLocation" }}
							{{- $region := index $physicalLoc "region" }}
							{{- $logicalLocs := index $location "logicalLocations" }}
							{
								"physicalLocation": {
									"artifactLocation": {
										"uri": {{ getQuotedString (index $artifactLoc "uri") }}
									},
									"region": {
										"startLine": {{ index $region "startLine" }}
									}
								}{{- if $logicalLocs }},
								"logicalLocations": [
									{{- $logicalSize := sub (len $logicalLocs) 1 }}
									{{- range $logicalIndex, $logicalLoc := $logicalLocs }}
									{
										"fullyQualifiedName": {{ getQuotedString (index $logicalLoc "fullyQualifiedName") }}
									}{{if lt $logicalIndex $logicalSize}},{{end}}
									{{- end }}
								]
								{{- end }}
							}{{if lt $locIndex $locSize}},{{end}}
							{{- end }}
						]{{- if $fixes }},
						"fixes": [
							{{- $fixSize := sub (len $fixes) 1 }}
							{{- range $fixIndex, $fix := $fixes }}
							{{- $fixDesc := index $fix "description" }}
							{{- $artifactChanges := index $fix "artifactChanges" }}
							{
								"description": {
									"text": {{ getQuotedString (index $fixDesc "text") }}
								},
								"artifactChanges": [
									{{- $changeSize := sub (len $artifactChanges) 1 }}
									{{- range $changeIndex, $change := $artifactChanges }}
									{{- $changeArtifact := index $change "artifactLocation" }}
									{{- $replacements := index $change "replacements" }}
									{
										"artifactLocation": {
											"uri": {{ getQuotedString (index $changeArtifact "uri") }}
										},
										"replacements": [
											{{- $replaceSize := sub (len $replacements) 1 }}
											{{- range $replaceIndex, $replacement := $replacements }}
											{{- $deletedRegion := index $replacement "deletedRegion" }}
											{{- $insertedContent := index $replacement "insertedContent" }}
											{
												"deletedRegion": {
													"startLine": {{ index $deletedRegion "startLine" }}
												},
												"insertedContent": {
													"text": {{ getQuotedString (index $insertedContent "text") }}
												}
											}{{if lt $replaceIndex $replaceSize}},{{end}}
											{{- end }}
										]
									}{{if lt $changeIndex $changeSize}},{{end}}
									{{- end }}
								]
							}{{if lt $fixIndex $fixSize}},{{end}}
							{{- end }}
						]
						{{- end }}
					}{{if lt $index $resultsSize}},{{end}}
					{{- end}}
				],
				{{- /* TODO: Add properties section for SAST (coverage) and upload results
				"properties": {
					"coverage": [
						{{- $coverageSize := sub (len $result.Summary.Coverage) 1 }}
						{{- range $coverageIndex, $coverage := $result.Summary.Coverage }}
						{
							"files": {{ $coverage.Files }},
							"isSupported": {{ $coverage.IsSupported }},
							"lang": "{{ $coverage.Lang }}",
							"type": "{{ $coverage.Type }}"
						}{{if lt $coverageIndex $coverageSize}},{{end}}
						{{- end }}
					]
					{{- if .Links.report }},
					"uploadResult": {
						"projectId": "{{ .Links.projectid }}",
						"snapshotId": "{{ .Links.snapshotid }}",
						"reportUrl": "{{ .Links.report }}"
					}
					{{- end }}
				},
				*/ -}}
				"automationDetails": {
					"id": "{{- getAutomationDetailsId (getValueFromConfig "project-name") (printf "%s" $findingType) }}"
				}
			}{{if lt $findingTypeIndex $findingTypesSize}},{{end}}{{- end}}	
		{{- end}}
		]
	}
{{end }} {{/* end main */}}

{{template "main" . }}

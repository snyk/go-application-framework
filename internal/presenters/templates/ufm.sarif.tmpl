{{define "main" }}
	{
		"$schema": "https://docs.oasis-open.org/sarif/sarif/v2.1.0/errata01/os/schemas/sarif-schema-2.1.0.json",
		"version": "2.1.0",
		"runs": [
		{{- range $resultIndex, $result := $.TestResults}}
			{{- $findingTypes := getFindingTypesFromTestResult $result }}
			{{- $findingType := index $findingTypes 0 }}
			{{- $issues := getIssuesFromTestResult $result }}
			{{- $issuesSize := sub (len $issues) 1 }}
			{{- $metadata := $result.GetMetadata }}
			{
				"tool": {
					"driver" : {
						"name" : "{{- convertTypeToDriverName (printf "%s" $findingType) }}",
						"semanticVersion" : "{{- getRuntimeInfo "version" }}",
						"version" : "{{- getRuntimeInfo "version" }}",
						"informationUri" : "https://docs.snyk.io/",
						"rules" : [
							{{- range $index, $issue := $issues }}
							{{- $tags := buildRuleTags $issue }}
							{{- $cvssScore := getRuleCVSSScore $issue }}
							{
								"id": {{ getQuotedString $issue.GetID }},
								"shortDescription": {
									"text": {{ getQuotedString (buildRuleShortDescription $issue) }}
								},
								"fullDescription": {
									"text": {{ getQuotedString (buildRuleFullDescription $issue) }}
								},
								"help": {
									"text": "",
									"markdown": {{ getQuotedString (buildRuleHelpMarkdown $issue $issue.GetFindingType) }}
								},
								"properties": {
									"tags": [
										{{- $tagsSize := sub (len $tags) 1 }}
										{{- range $tagIndex, $tag := $tags }}
										{{ getQuotedString (printf "%v" $tag) }}{{if lt $tagIndex $tagsSize}},{{end}}
										{{- end }}
									]{{if ge $cvssScore 0.0}},
									"cvssv3_baseScore": {{ $cvssScore }},
									"security-severity": {{ getQuotedString (printf "%.1f" $cvssScore) }}{{end}}
								}
							}{{if lt $index $issuesSize}},{{end}}
							{{- end }}
						]
						{{- $dependencyCount := index $metadata "dependency-count" }}
						{{- if $dependencyCount }},
						"properties": {
							"artifactsScanned": {{ $dependencyCount }}
						}
						{{- end }}
					}
				},
			"results": [
				{{- $targetFile := index $result.GetMetadata "display-target-file" }}
				{{- range $index, $issue := $issues }}
				{{- $location := buildLocationFromIssue $issue $targetFile }}
				{{- $physicalLoc := index $location "physicalLocation" }}
				{{- $region := index $physicalLoc "region" }}
				{{- $artifactLocation := index $physicalLoc "artifactLocation" }}
				{{- $fixes := buildFixesFromIssue $issue }}
				{{- $ignoreDetails := $issue.GetIgnoreDetails }}
				{
					"ruleId": {{ getQuotedString $issue.GetID }},
					"level": {{ getQuotedString (severityToSarifLevel $issue.GetSeverity) }},
					"message": {
						"text": {{ getQuotedString (formatIssueMessage $issue) }}
					},
					"locations": [
						{{- if $location }}
					
						{{- $logicalLocs := index $location "logicalLocations" }}
						{
							"physicalLocation": {
								"artifactLocation": {
									"uri": {{ getQuotedString (index $artifactLocation "uri") }}
								},
								"region": {
									"startLine": {{ index $region "startLine" }}
								}
							},
							"logicalLocations": [
								{{- range $logLoc := $logicalLocs }}
								{
									"fullyQualifiedName": {{ getQuotedString (index $logLoc "fullyQualifiedName") }}
								}
								{{- end }}
							]
						}
						{{- end }}
					]
					{{- if $fixes }},
					"fixes": [
						{{- $fixSize := sub (len $fixes) 1 }}
						{{- range $fixIndex, $fix := $fixes }}
						{
							"description": {
								"text": {{ getQuotedString (index (index $fix "description") "text") }}
							},
							"artifactChanges": [
								{{- $artifactChanges := index $fix "artifactChanges" }}
								{{- $changeSize := sub (len $artifactChanges) 1 }}
								{{- range $changeIndex, $change := $artifactChanges }}
								{
									"artifactLocation": {
										"uri": {{ getQuotedString (index $artifactLocation "uri") }}
									},
									"replacements": [
										{{- $replacements := index $change "replacements" }}
										{{- $replaceSize := sub (len $replacements) 1 }}
										{{- range $replaceIndex, $replacement := $replacements }}
										{
											"deletedRegion": {
												"startLine": {{ index (index $replacement "deletedRegion") "startLine" }}
											},
											"insertedContent": {
												"text": {{ getQuotedString (index (index $replacement "insertedContent") "text") }}
											}
										}{{if lt $replaceIndex $replaceSize}},{{end}}
										{{- end }}
									]
								}{{if lt $changeIndex $changeSize}},{{end}}
								{{- end }}
							]
						}{{if lt $fixIndex $fixSize}},{{end}}
						{{- end }}
					]
					{{- end }}
					{{- if $ignoreDetails }},
					"suppressions": [
						{
							{{- $policyID := $ignoreDetails.GetPolicyID }}
							{{- if $policyID }}
							"guid": {{ getQuotedString $policyID }},
							{{- end }}
							{{- $status := printf "%s" $ignoreDetails.GetStatus }}
							{{- if eq $status "ignored" }}
							"status": "accepted"
							{{- else if eq $status "pending_ignore_approval" }}
							"status": "underReview"
							{{- else if eq $status "other" }}
							"status": "rejected"
							{{- else }}
							"status": "accepted"
							{{- end }},
							{{- $justification := $ignoreDetails.GetJustification }}
							{{- if $justification }}
							"justification": {{ getQuotedString $justification }},
							{{- end }}
							"kind": "external"
							{{- $reasonType := $ignoreDetails.GetIgnoreReasonType }}
							{{- $createdAt := $ignoreDetails.GetCreatedAt }}
							{{- $expiresAt := $ignoreDetails.GetExpiresAt }}
							{{- $ignoredBy := $ignoreDetails.GetIgnoredBy }}
							{{- if or $reasonType $createdAt $expiresAt $ignoredBy }},
							"properties": {
								{{- if $reasonType }}
								"category": {{ getQuotedString $reasonType }}{{if or $expiresAt $createdAt $ignoredBy}},{{end}}
								{{- end }}
								{{- if $expiresAt }}
								"expiration": "{{ $expiresAt.Format "2006-01-02T15:04:05Z07:00" }}"{{if or $createdAt $ignoredBy}},{{end}}
								{{- end }}
								{{- if $createdAt }}
								"ignoredOn": "{{ $createdAt.Format "2006-01-02T15:04:05Z07:00" }}"{{if $ignoredBy}},{{end}}
								{{- end }}
								{{- if $ignoredBy }}
								"ignoredBy": {
									"name": {{ getQuotedString $ignoredBy.Name }},
									{{- if $ignoredBy.Email }}
									"email": {{ getQuotedString $ignoredBy.Email }}
									{{- else }}
									"email": ""
									{{- end }}
								}
								{{- end }}
							}
							{{- end }}
						}
					]
					{{- end }}
				}{{if lt $index $issuesSize}},{{end}}
				{{- end}}
			],
				{{- /* TODO: Add properties section for SAST (coverage) and upload results
				"properties": {
					"coverage": [
						{{- $coverageSize := sub (len $result.Summary.Coverage) 1 }}
						{{- range $coverageIndex, $coverage := $result.Summary.Coverage }}
						{
							"files": {{ $coverage.Files }},
							"isSupported": {{ $coverage.IsSupported }},
							"lang": "{{ $coverage.Lang }}",
							"type": "{{ $coverage.Type }}"
						}{{if lt $coverageIndex $coverageSize}},{{end}}
						{{- end }}
					]
					{{- if .Links.report }},
					"uploadResult": {
						"projectId": "{{ .Links.projectid }}",
						"snapshotId": "{{ .Links.snapshotid }}",
						"reportUrl": "{{ .Links.report }}"
					}
					{{- end }}
				},
				*/ -}}
				"automationDetails": {
					{{- $projectName := index $metadata "project-name" }}
					"id": "{{- getAutomationDetailsId (printf "%s/%d" $projectName $resultIndex) (printf "%s" $findingType) }}"
				}
			}{{if (lt $resultIndex (sub (len $.TestResults) 1))}},{{end}}{{- end}}
		]
	}
{{end }} {{/* end main */}}

{{template "main" . }}

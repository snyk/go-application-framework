{{- define "details" }}
    {{- $sortedFindings := $.Finding.Findings | sortFindingBy "Attributes.Rating.Severity.Value" $.Finding.Summary.SeverityOrderAsc }}
    {{- $openFindings := $sortedFindings | filterFinding (notHasField "Attributes.Suppression.Kind") }}
    {{- $ignoredFindings := $sortedFindings | filterFinding (hasField "Attributes.Suppression.Kind") }}
    {{- $hasOpenFindings := gt ($openFindings | len) 0 }}
    {{- $hasIgnoredFindings := gt ($ignoredFindings | len) 0 }}
    {{- if $hasOpenFindings }}{{ "Open Issues" | title }}
            {{- range $finding := $openFindings }}
                {{- renderToString "finding" $finding }}
            {{- end }}
    {{- end }}
    {{- if or (and $hasOpenFindings $hasIgnoredFindings) (eq (getValueFromConfig "include-ignores") "true") }}
        {{- divider}}
    {{- end}}
{{- if eq (getValueFromConfig "include-ignores") "true" }}{{"Ignored Issues" | title }}
    {{- if $hasIgnoredFindings }}
            {{- range $finding := $ignoredFindings}}
                    {{- renderToString "finding" $finding }}
            {{- end }}
            {{- else}}  There are no ignored issues
    {{- end}}
{{tip "Ignores are currently managed in the Snyk Web UI.\nTo edit or remove the ignore please go to: https://app.snyk.io/"}}
{{- end}}
{{- end}}{{/* end "details" */}}

{{define "header" }}
{{ print "Testing " .Summary.TestPath " ..." | bold }}
{{end }}

{{define "summary"}}{{ "Test Summary" | bold }}

  Organization:      {{.Summary.Org}}
  Test type:         {{.Summary.Type}}
  Project path:      {{.Summary.TestPath}}

  Total issues:   {{.Summary.TotalIssueCount}}{{ if .Summary.TotalIssueCount }}
  Ignored issues: {{ .Summary.IgnoredIssueCountWithSeverities }}
  Open issues:    {{ .Summary.OpenIssueCountWithSeverities }}{{ end }}{{end}}

{{define "main" }}
{{- template "header"  . }}
{{- template "details" . }}

{{ if or (eq (getValueFromConfig "severity-threshold") "low") (eq (getValueFromConfig "severity-threshold") "medium") (eq (getValueFromConfig "severity-threshold") "high")}}
    {{ tip "You are currently viewing results with --severity-threshold applied.\nTo view all issues, remove the --severity-threshold flag"}}
{{ end }}{{- box (renderToString "summary" .)}}

{{- if ne (getValueFromConfig "include-ignores") "true" }}
    {{tip "To view ignored issues, use the --include-ignores option."}}
{{- end }}
{{end }} {{/* end main */}}

{{template "main" . }}

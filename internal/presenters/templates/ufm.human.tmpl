{{- define "issueHeader"}}
 {{- $severity := .GetEffectiveSeverity }}
 {{- $title := .GetTitle }}
 {{- $prefix := "✗" }}
 {{- $ignoreDetails := .GetIgnoreDetails }}
    {{- if $ignoreDetails }}
        {{- $ignoreStatus := $ignoreDetails.GetStatus }}
        {{- if eq $ignoreStatus "ignored" }}{{- $prefix = "! [IGNORED]" }}
        {{- else if eq $ignoreStatus "pending_ignore_approval" }}{{- $prefix = "! [PENDING IGNORE...]" }}
        {{- end -}}
    {{- end -}}
{{- printf " %s %s %s" $prefix (printf "[%s]" $severity | renderInSeverityColor) ($title | bold) -}}
{{- end }} {{/* end issueHeader */}}

{{- define "issueBody" }}
   Finding ID: {{ .GetID }}
    {{- $findingType := .GetFindingType }}
    {{- if or (eq $findingType "license") (eq $findingType "sca") }}
   Info: https://snyk.io/vuln/{{ .GetID }}
    {{- else }}
   Info: {{ .GetDescription }}
	{{- end }}
   {{- $componentName := getIssueMetadata . "component-name" }}
   {{- if $componentName }}
   Introduced by: {{ $componentName }}
   {{- end }}
   {{- $depPaths := getIssueMetadata . "dependency-paths" }}
   {{- if $depPaths }}
   {{- if gt (len $depPaths) 0 }}
   {{- $path := index $depPaths 0 }}
   Introduced through:{{- range $idx, $pkg := $path }} {{if $idx}}> {{end}}{{ $pkg.Name }}@{{ $pkg.Version }}{{- end }}
   {{- end }}
   {{- end }}
   {{- range $location := .GetSourceLocations}}
        {{- if $location}}
   Path: {{$location.FilePath}}, line {{$location.FromLine}}{{- if $location.ToLine}} to {{$location.ToLine}}{{- end}}
        {{- end }}
   {{- end }}
   {{- $riskScore := .GetRiskScore }}
   {{- if $riskScore }}
   Risk Score: {{ $riskScore }}
   {{- end }}
   {{- $reachability := .GetReachability }}
   {{- $findingType := .GetFindingType }}
   {{- if $reachability }}
    {{- $reachabilityString := "" }}
    {{- if eq $reachability.Reachability "function" }}
        {{- $reachabilityString = "Reachable" }}
    {{- else if eq $reachability.Reachability "no_info" }}
        {{- $reachabilityString = "No Path Found" }}
    {{- else }}
        {{- $reachabilityString = "Not Applicable" }}
    {{- end }}
   Reachability: {{ $reachabilityString }}
   {{- end }}

    {{- $ignoreDetails := .GetIgnoreDetails}}
    {{- if $ignoreDetails }}
        {{- $ignoreStatus := $ignoreDetails.GetStatus }}
        {{- if or (eq $ignoreStatus "ignored") (eq $ignoreStatus "pending_ignore_approval") }}

   Expiration: {{ if $ignoreDetails.GetExpiresAt }}{{ $ignoreDetails.GetExpiresAt.Format "January 02, 2006" }} {{- else }}never {{- end }}
   Category:   {{ if $ignoreDetails.GetIgnoreReasonType }}{{ $ignoreDetails.GetIgnoreReasonType }} {{- else }}unavailable {{- end }}
   Ignored on: {{ if $ignoreDetails.GetCreatedAt }}{{ $ignoreDetails.GetCreatedAt.Format "January 02, 2006" }} {{- else }}unavailable {{- end }}
{{- if $ignoreDetails.GetIgnoredBy }}
   Ignored by: {{if $ignoreDetails.GetIgnoredBy.Name }}{{ $ignoreDetails.GetIgnoredBy.Name }} {{- else }}unavailable {{- end }}
{{- end }}
{{- if $ignoreDetails.GetJustification }}
   Reason:     {{ $ignoreDetails.GetJustification }}
{{- end }}
    {{- end}}
    {{- end}}
{{- end}} {{/* end issueBody */}}

{{- define "issueDetails" }}
{{- template "issueHeader" . }}
{{- template "issueBody" . }}
{{- end }} {{/* end issueDetails */}}

{{- define "testSummary"}}{{ "Test Summary" | bold }}
{{- "\n" }}
{{- $metadata := .GetMetadata }}
{{- $targetDirectory := index $metadata "target-directory" }}
{{- if not $targetDirectory }}
{{- $targetDirectory = getValueFromConfig "targetDirectory" }}
{{- end }}
{{- $findingTypes := getFindingTypesFromTestResult . }}
  Organization:      {{ getValueFromConfig "internal_org_slug" }}
  Test type:         {{ determineProductNameFromFindingTypes $findingTypes }}
  Project path:      {{ $targetDirectory }}

{{- range $findingType := $findingTypes }}
  {{- $issuesForType := getIssuesFromTestResult $ $findingType }}
  {{- $summaries := getSummariesFromIssues $issuesForType }}
  {{- $effectiveSummary := index $summaries "effective" }}
  {{- $rawSummary := index $summaries "raw" }}
  {{- $ignoredSummary := index $summaries "ignored" }}
  {{- $effectiveSeverities := index $effectiveSummary.CountBy "severity" }}
  {{- $ignoredSeverities := index $ignoredSummary.CountBy "severity" }}
  {{- $totalIssueCount := $rawSummary.Count }}
  {{- $openIssueCount := $effectiveSummary.Count }}
  {{- $ignoredIssueCount := $ignoredSummary.Count }}

  Total {{ convertTypeToIssueName $findingType | toLowerCase }} issues: {{ $totalIssueCount }}
  {{- if gt $totalIssueCount 0}}
  Ignored: {{ print $ignoredIssueCount | bold }} [{{- range $severity := getSeverities | reverse }}{{- $ignoredCount := index $ignoredSeverities $severity }}{{- print " " $ignoredCount " " $severity " " | renderInSeverityColor }}{{- end}}]
  Open   : {{ print $openIssueCount | bold }} [{{- range $severity := getSeverities | reverse }}{{- $countFound := index $effectiveSeverities $severity }}{{- print " " $countFound " " $severity " " | renderInSeverityColor }}{{- end}}]{{- end}}
{{- end}}
{{- end }} {{/* end testSummary */}}

{{- define "resultHeader" }}
   {{- $metadata := .GetMetadata }}
   {{- $testingSubject := getValueFromConfig "targetDirectory" }}
   {{- $targetFile := index $metadata "display-target-file" }}
   {{- if $targetFile }} {{- $testingSubject = $targetFile }} {{- end }}
   {{- $dependencyCount := index $metadata "dependency-count" }}
   {{- /* Get all open issues, no matter what type */}}
   {{- $issues := getIssuesFromTestResult . }}
   {{- $openIssues := sortAndFilterIssues $issues false }}
   {{- /* Count vulnerable paths */}}
   {{- $vulnerablePaths := 0 }}
   {{- range $issue := $openIssues }}
   {{- $depPaths := getIssueMetadata $issue "dependency-paths" }}
   {{- if $depPaths }}{{- $vulnerablePaths = add (len $depPaths) $vulnerablePaths }}{{- end }}
   {{- end }}
   {{- printf "Testing  (%s) ..." $testingSubject | bold }}
   {{- "\n" }}

   {{- if gt (int $dependencyCount) 0 }}
Tested {{ int $dependencyCount }} dependencies for known issues, found {{ len $openIssues }} issues, {{ $vulnerablePaths }} vulnerable paths.
{{- "\n" }}
{{- end }}
{{- end }}

{{- define "resultBody" }}
    {{- /* Render Issue details per finding type */}}
    {{- $findingTypes := getFindingTypesFromTestResult . }}
    {{- range $findingType := $findingTypes }}
        {{- $allIssues := getIssuesFromTestResult $ $findingType }}
        {{- $summaries := getSummariesFromIssues $allIssues }}
        {{- $effectiveSummary := index $summaries "effective" }}
        {{- $ignoredSummary := index $summaries "ignored" }}
        {{- $openIssues := getSortedIssuesFromSummary $effectiveSummary }}

        {{- "\n" }}
        {{- printf "Open %s issues: %d" (convertTypeToIssueName $findingType) (len $openIssues) | bold }}
        {{- "\n" }}

        {{- /* Render open issues */}}
        {{- range $issue := $openIssues }}
            {{- "\n" }}
            {{- template "issueDetails" $issue }}
            {{- "\n" }}
            {{- end }}

            {{- /* Render suppressed issues if any exist */}}
            {{- if eq (getValueFromConfig "include-ignores") "true" }}
                {{- $suppressedIssues := getSortedIssuesFromSummary $ignoredSummary }}
                {{- if gt ($suppressedIssues | len) 0 }}
                    {{- "\n" }}
                    {{- printf "Ignored %s issues: %d\n" (convertTypeToIssueName $findingType) (len $suppressedIssues) | bold }}

                    {{- range $issue := $suppressedIssues }}
                        {{- "\n" }}
                        {{- template "issueDetails" $issue }}
                        {{- "\n" }}
                    {{- end }}
            {{- end }}
        {{- end }}

        {{- /* Render remediation summary */}}
        {{- if eq $findingType "sca" }}
            {{- template "remediationSummary" $openIssues }}
        {{- end }}
    {{- end }}
{{- end }}

{{- define "issueRemediationDetails" }}
    {{- $issue := . }}
    {{- $componentName := getIssueMetadata $issue "component-name" }}
    {{- $severity := $issue.GetEffectiveSeverity }}
    {{- $title := colorBySeverity $severity ($issue.GetTitle | bold) }}
    {{- $severityBadge := colorBySeverity $severity (printf "[%s]" ($severity | toUpperCase)) }}
    {{- $url := printf "[https://security.snyk.io/vuln/%s]" $issue.GetID }}
    {{- $pkgDisplay := $componentName | bold }}
    {{- printf "  ✗ %s %s %s in %s" $title $severityBadge $url $pkgDisplay }}
    {{- "\n" }}

    {{- $depPaths := getIssueMetadata $issue "dependency-paths" }}
    {{- if $depPaths }}
        {{- $pathCount := len $depPaths }}
        {{- if gt $pathCount 0 }}
            {{- $firstPath := index $depPaths 0 }}
            {{- $pathStr := "" }}
            {{- range $i, $pkg := $firstPath }}
                {{- if eq $i 0 }}
                    {{- $pathStr = printf "%s@%s" $pkg.Name $pkg.Version }}
                {{- else }}
                    {{- $pathStr = printf "%s > %s@%s" $pathStr $pkg.Name $pkg.Version }}
                {{- end }}
            {{- end }}
            {{- if gt $pathCount 1 }}
                {{- printf "    introduced by %s and %d other path(s)" $pathStr (sub $pathCount 1) }}
            {{- else }}
                {{- printf "    introduced by %s" $pathStr }}
            {{- end }}
            {{- "\n" }}
        {{- end }}
    {{- end }}
{{- end }}

{{- define "remediationSummary" }}
    {{- $remediation := getRemediationSummary $ }}

    {{- if or ($remediation.HasUpgrades) ($remediation.HasPins) ($remediation.HasUnresolved) }}
        {{- "\n" }}

        {{- if $remediation.HasUpgrades }}
            {{- "Issues to fix by upgrading:" | bold | renderGreen }}
            {{- "\n" }}
            {{- range $upgrade := $remediation.Upgrades }}
                {{- $fromPkg := printf "%s@%s" $upgrade.FromPackage.Name $upgrade.FromPackage.Version | bold }}
                {{- $toPkg := printf "%s@%s" $upgrade.ToPackage.Name $upgrade.ToPackage.Version | bold }}
                {{- printf "\n  Upgrade %s to %s to fix" $fromPkg $toPkg }}
                {{- "\n" }}
                {{- range $issue := $upgrade.FixedIssues }}
                    {{- template "issueRemediationDetails" $issue }}
                {{- end }}
            {{- end }}
        {{- end }}

        {{- /* Render Pins */}}
        {{- if $remediation.HasPins }}
            {{- "\nIssues to fix by upgrading dependencies:" | bold | renderGreen }}
            {{- "\n" }}
            {{- range $pin := $remediation.Pins }}
                {{- $fromPkg := printf "%s@%s" $pin.FromPackage.Name $pin.FromPackage.Version | bold }}
                {{- $toPkg := printf "%s@%s" $pin.ToPackage.Name $pin.ToPackage.Version | bold }}
                {{- printf "\n  Pin %s to %s to fix" $fromPkg $toPkg }}
                {{- "\n" }}
                {{- range $issue := $pin.FixedIssues }}
                    {{- template "issueRemediationDetails" $issue }}
                {{- end }}
            {{- end }}
        {{- end }}

        {{- /* Render Unresolved */}}
        {{- if $remediation.HasUnresolved }}
            {{- "\n" }}
            {{- "Issues with no direct upgrade or patch:" | bold | renderGray }}
            {{- "\n" }}
            {{- range $issue := $remediation.Unresolved }}
                {{- template "issueRemediationDetails" $issue }}
                {{- /* Show fixed-in versions for unresolved issues */}}
                {{- $fixedInVersions := getIssueMetadata $issue "fixed-in-versions" }}
                {{- if $fixedInVersions }}
                    {{- printf "  This issue was fixed in: %s" (join $fixedInVersions ", " | bold) }}
                    {{- "\n" }}
                {{- end }}
            {{- end }}
        {{- end }}
    {{- end }}
{{- end }} {{/* end remediationSummary */}}

{{- define "resultFooter" }}
    {{- "\n" }}
    {{- /* Render test summary */}}
    {{- box (renderToString "testSummary" $) }}

    {{- "\n" }}
    {{- with $.GetMetadataValue "target-directory" }}
	    {{- $targetId := getTargetId . }}
        {{- if not (hasPrefix $targetId "pkg:git") }}
            {{- tip "Some capabilities, including the ability to apply ignores, are unavailable. Retest the project with the --remote-repo-url parameter or from within a repository to enable full functionality."}}
        {{- end }}
    {{- end }}
{{- end }}

{{- /* Main template */}}
{{- define "main" }}
    {{- /* Render each result */}}
    {{- range $resultIndex, $result := $.TestResults}}
        {{- template "resultHeader" $result}}
        {{- template "resultBody" $result}}
        {{- template "resultFooter" $result}}
    {{- end }}

    {{- /* Show hint if results are filtered */}}
    {{- $severityThresholdKey := "severity-threshold"}}
        {{- if not (eq (getValueFromConfig $severityThresholdKey) "") }}
        {{- "\n" }}
        {{- printf "You are currently viewing results with --%s applied.\nTo view all issues, remove the --%s flag" $severityThresholdKey $severityThresholdKey | tip}}
    {{- end }}

    {{- if ne (getValueFromConfig "include-ignores") "true" }}
        {{- "\n" }}
        {{- tip "To view ignored issues, use the --include-ignores option."}}
    {{- end }}
    {{- "\n" }}
{{- end }} {{/* end main */}}

{{- template "main" . }}

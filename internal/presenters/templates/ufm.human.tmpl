{{- define "issueHeader"}}
 {{- $severity := .GetEffectiveSeverity }}
 {{- $title := .GetTitle }}
 {{- $prefix := "âœ—" }}
 {{- $ignoreDetails := .GetIgnoreDetails }}
    {{- if $ignoreDetails }}
        {{- $ignoreStatus := $ignoreDetails.GetStatus }}
        {{- if eq $ignoreStatus "ignored" }}{{- $prefix = "! [IGNORED]" }}
        {{- else if eq $ignoreStatus "pending_ignore_approval" }}{{- $prefix = "! [PENDING IGNORE...]" }}
        {{- end -}}
    {{- end -}}
{{- printf " %s %s %s" $prefix (printf "[%s]" ($severity | toUpperCase) | renderInSeverityColor) ($title | bold) -}}
{{- end }} {{/* end issueHeader */}}

{{- define "issueBody" }}
   Finding ID: {{ .GetID }}
   Info: https://snyk.io/vuln/{{ .GetID }}
   {{- $componentName := getData . "component-name" }}
   {{- if $componentName }}
   Introduced by: {{ $componentName }}
   {{- end }}
   {{- $depPaths := getData . "dependency-paths" }}
   {{- if $depPaths }}
   {{- if gt (len $depPaths) 0 }}
   {{- $path := index $depPaths 0 }}
   Introduced through:{{- range $idx, $pkg := $path }} {{if $idx}}> {{end}}{{ $pkg.Name }}@{{ $pkg.Version }}{{- end }}
   {{- end }}
   {{- end }}
   {{- $riskScore := .GetRiskScore }}
   {{- if $riskScore }}
   Risk Score: {{ $riskScore }}
   {{- end }}
   {{- $reachability := .GetReachability }}
   {{- $findingType := .GetFindingType }}
   {{- if eq (printf "%s" $findingType) "license" }}
   Reachability: Not Applicable
   {{- else if $reachability }}
   Reachability: {{ $reachability.Reachability }}
   {{- else }}
   Reachability: No Path Found
   {{- end }}
{{- end}} {{/* end issueBody */}}

{{- define "issueDetails" }}
{{- template "issueHeader" . }}
{{- template "issueBody" . }}
{{- end }} {{/* end issueDetails */}}

{{- define "testSummary"}}{{ "Test Summary" | bold }}
{{- $metadata := .GetMetadata }}
{{- $targetDirectory := index $metadata "target-directory" }}
  Organization:      {{ getValueFromConfig "internal_org_slug" }}
  Test type:
  Project path:      {{ $targetDirectory }}
{{- end }} {{/* end testSummary */}}

{{- define "main" }}
{{- range $resultIndex, $result := $.TestResults}}
    {{- $metadata := $result.GetMetadata }}
    {{- $targetFile := index $metadata "display-target-file" }}
    {{- $dependencyCount := index $metadata "dependency-count" }}
    {{- /* Get all open issues, no matter what type */}}
    {{- $issues := getIssuesFromTestResult $result }}
    {{- $openIssues := filterIssuesBySuppressionStatus $issues false }}
    {{- /* Count vulnerable paths */}}
    {{- $vulnerablePaths := 0 }}
    {{- range $issue := $openIssues }}
        {{- $depPaths := getData $issue "dependency-paths" }}
        {{- $vulnerablePaths = add (len $depPaths) $vulnerablePaths }}
    {{- end }}
{{- printf "Testing  (%s) ..." $targetFile | bold }}
{{- "\n" }}

{{- if gt (int $dependencyCount) 0 }}
Tested {{ int $dependencyCount }} dependencies for known issues, found {{ len $openIssues }} issues, {{ $vulnerablePaths }} vulnerable paths.
{{- "\n" }}
{{- end }}

    {{- /* Render Issue details per finding type */}}
    {{- $findingTypes := getFindingTypesFromTestResult $result }}
    {{- range $findingType := $findingTypes }}
        {{- $allIssues := getIssuesFromTestResult $result $findingType }}
        {{- $openIssues := filterIssuesBySuppressionStatus $allIssues false }}

        {{- "\n" }}
        {{- printf "Open %s issues: %d" (convertTypeToIssueName $findingType) (len $openIssues) | bold }}
        {{- "\n" }}

        {{- /* Render open issues */}}
        {{- range $issue := $openIssues }}
            {{- "\n" }}
            {{- template "issueDetails" $issue }}
            {{- "\n" }}
        {{- end }}

        {{- /* Render suppressed issues if any exist */}}
        {{- if eq (getValueFromConfig "include-ignores") "true" }}
            {{- $suppressedIssues := filterIssuesBySuppressionStatus $allIssues true }}
            {{- if gt ($suppressedIssues | len) 0 }}
{{ printf "Ignored %s issues: %d\n" (convertTypeToIssueName $findingType) (len $suppressedIssues) | bold }}

                {{- range $issue := $suppressedIssues }}
                    {{- "\n" }}
                    {{- template "issueDetails" $issue }}
                    {{- "\n" }}
                {{- end }}
            {{- end }}
        {{- end }}
    {{- end }}

    {{- /* Render test summary */}}
    {{- "\n" }}
    {{- box (renderToString "testSummary" $result) }}
{{- end }}

{{- if ne (getValueFromConfig "include-ignores") "true" }}
{{- "\n" }}
{{- tip "To view ignored issues, use the --include-ignores option."}}
{{- "\n" }}
{{- end }}


{{- end }} {{/* end main */}}

{{- template "main" . }}

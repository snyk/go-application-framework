# LDX-Sync Configuration API Client

This package provides a Go client for interacting with the LDX-Sync configuration API. It automatically generates client code from OpenAPI specifications and provides high-level abstractions for configuration management.

## Architecture Overview

The LDX-Sync API client follows a multi-layered architecture:

1. **OpenAPI Specification** - Source of truth for API contracts
2. **Generated Client Code** - Auto-generated from OpenAPI spec
3. **High-Level Client** - Simplified interface for configuration management
4. **Default Functions** - Integration with the application framework's configuration system
5. **Resolvers** - Logic for resolving organizations and configurations

## Design Patterns

The LDX-Sync configuration client implements several well-established design patterns:

### 1. Facade Pattern
The `ldx_sync_config.go` acts as a **Facade** that hides the complexity of the underlying LDX-Sync API client. It provides a simplified interface (`LdxSyncConfigClient`) that shields consumers from:
- API version details (`v20241015`)
- Generated type complexity (`ConfigResponse`, `ConfigData`, etc.)
- HTTP client implementation details
- Response parsing and error handling

### 2. Adapter Pattern
The client transforms the generated API types into domain-specific types (`Configuration`, `SeverityFilter`, etc.) that are more meaningful to consumers. This is a classic **Adapter** pattern.

### 3. Repository Pattern
The `LdxSyncConfigClient` acts as a **Repository** that abstracts data access, providing a clean interface for retrieving configuration data without exposing the underlying data source details.

### 4. API Gateway Pattern
This is essentially a microservice API Gateway pattern where:
- External API calls are abstracted
- Multiple API versions are hidden behind a stable interface
- Request/response transformation happens transparently

## Specification Download and Code Generation

### 1. Specification Download

The OpenAPI specification is automatically downloaded and updated using the `pull-down-ldx-sync-api.sh` script:

```bash
./scripts/pull-down-ldx-sync-api.sh
```

**What the script does:**
- Clones/updates the `snyk/ldx-sync` repository from GitHub
- Copies the OpenAPI spec from `internal/api/rest/versions/2024-10-15/spec.yaml`
- Places it at `pkg/apiclients/ldx_sync_config/ldx_sync/2024-10-15/spec.yaml`

**Downloaded file:**
- `pkg/apiclients/ldx_sync_config/ldx_sync/2024-10-15/spec.yaml` - OpenAPI 3.0 specification

### 2. Code Generation Process

The specification is compiled into Go client code using `oapi-codegen`:

#### Generated Files

1. **`pkg/apiclients/ldx_sync_config/ldx_sync/2024-10-15/ldx_sync.go`**
   - Generated by `oapi-codegen` from the OpenAPI spec
   - Contains low-level HTTP client and data models
   - Includes types like `ConfigResponse`, `ConfigData`, `Organization`, etc.
   - Generated with: `go tool github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen`

2. **`pkg/apiclients/mocks/ldx_sync_config.go`**
   - Generated by `mockgen` for testing
   - Contains mock implementations of the `LdxSyncConfigClient` interface
   - Generated with: `go tool github.com/golang/mock/mockgen`

#### Generation Commands

```bash
# Generate OpenAPI client code
cd pkg/apiclients/ldx_sync_config/ldx_sync/2024-10-15
go generate

# Generate mock files
cd pkg/apiclients/ldx_sync_config
go generate
```

#### Configuration Files

- **`spec.config.yaml`** - Configuration for `oapi-codegen`:
  ```yaml
  package: v20241015
  generate:
    models: true
    client: true
  output: ldx_sync.go
  ```

- **`gen.go`** - Contains the `//go:generate` directive:
  ```go
  //go:generate go tool github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen -package=v20241015 -config spec.config.yaml spec.yaml
  ```

## API Client Architecture

### Low-Level Generated Client

The generated `ldx_sync.go` provides:
- HTTP client with request/response handling
- Type-safe data models matching the OpenAPI spec
- Raw API response structures (`ConfigResponse`, `ConfigData`, etc.)

### High-Level Client Interface

The `LdxSyncConfigClient` interface provides a simplified API:

```go
type LdxSyncConfigClient interface {
    GetConfiguration(ctx context.Context, params GetConfigurationParams) (*Configuration, error)
}
```

### Configuration Extraction

The high-level client extracts and transforms raw API responses into a simplified `Configuration` struct:

```go
type Configuration struct {
    Organization   string
    SeverityFilter *SeverityFilter
    ProductConfig  *ProductConfig
    AutoScan       bool
    TrustedFolders []string
    ProxyConfig    *ProxyConfig
    // ... additional fields
}
```

## Client Usage Patterns

The LDX-Sync configuration system uses two different clients for different purposes:

### **`LdxSyncConfigClient`** - Primary Client
- **Purpose**: All LDX-Sync configuration operations
- **Used for**: Configuration retrieval, organization resolution from LDX-Sync
- **Returns**: High-level `Configuration` struct
- **Type Safety**: Generated from OpenAPI spec

### **`api.ApiClient`** - Fallback Client  
- **Purpose**: Standard Snyk API operations
- **Used for**: Organization slug validation, default org lookup, fallback operations
- **Returns**: Raw API responses
- **Integration**: Part of main application framework

## System Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           LDX-Sync Configuration System                         │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────────────────────────────────────────────┐
│ Snyk Language   │    │                Application Framework                    │
│ Server          │    │                                                         │
│                 │    │  ┌─────────────────┐    ┌─────────────────────────────┐ │
│ ┌─────────────┐ │    │  │ Default         │    │ Resolvers                   │ │
│ │ Configuration││    │  │ Functions       │    │                             │ │
│ │ Access      │ │    │  │                 │    │ ┌─────────────────────────┐ │ │
│ │             │ │    │  │ ┌─────────────┐ │    │ │ TryResolveOrganization  │ │ │
│ │ c.Engine()  │ │    │  │ │DefaultFunc  │ │    │ │                         │ │ │
│ │ .GetConfig  │ │    │  │ │Organization │ │    │ │ Uses: LdxSyncConfigClient││ │
│ │ (LDX_SYNC_  │ │    │  │ │Ldx          │ │    │ │                         │ │ │
│ │  CONFIG)    │ │    │  │ │             │ │    │ └─────────────────────────┘ │ │
│ │             │ │    │  │ │ Uses: Both  │ │    │                             │ │
│ └─────────────┘ │    │  │ │ Clients     │ │    │ ┌─────────────────────────┐ │ │
│                 │    │  │ └─────────────┘ │    │ │ GetConfig               │ │ │
│                 │    │  │                 │    │ │                         │ │ │
│                 │    │  │ ┌─────────────┐ │    │ │ Uses: LdxSyncConfigClient││ │
│                 │    │  │ │DefaultFunc  │ │    │ │                         │ │ │
│                 │    │  │ │LdxSyncConfig│ │    │ └─────────────────────────┘ │ │
│                 │    │  │ │             │ │    │                             │ │
│                 │    │  │ │ Uses:       │ │    └─────────────────────────────┘ │
│                 │    │  │ │ LdxSyncConfig││                                    │
│                 │    │  │ │ Client Only  ││                                    │
│                 │    │  │ └─────────────┘ │                                    │
│                 │    │  └─────────────────┘                                    │
│                 │    └─────────────────────────────────────────────────────────┘
└─────────────────┘
         │
         │ Gets Configuration struct
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────┐    ┌─────────────────────────────────────────┐
│     LdxSyncConfigClient         │    │           api.ApiClient                │
│                                 │    │                                         │
│ ┌─────────────────────────────┐ │    │ ┌─────────────────────────────────────┐ │
│ │ GetConfiguration()          │ │    │ │ GetOrgIdFromSlug()                  │ │
│ │                             │ │    │ │ GetDefaultOrgId()                   │ │
│ │ Purpose: LDX-Sync config    │ │    │ │                                     │ │
│ │ retrieval and organization  │ │    │ │ Purpose: Standard organization      │ │
│ │ resolution                  │ │    │ │ operations (slug validation,        │ │
│ │                             │ │    │ │ default org lookup)                 │ │
│ └─────────────────────────────┘ │    │ └─────────────────────────────────────┘ │
│                                 │    │                                         │
│ ┌─────────────────────────────┐ │    │                                         │
│ │ Internal: Generated         │ │    │                                         │
│ │ OpenAPI Client              │ │    │                                         │
│ │ (v20241015.Client)          │ │    │                                         │
│ └─────────────────────────────┘ │    │                                         │
└─────────────────────────────────┘    └─────────────────────────────────────────┘
         │
         │ Uses internally
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Generated OpenAPI Client                                │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │ v20241015.Client                                                           │ │
│ │                                                                             │ │
│ │ • GetConfigWithResponse()                                                  │ │
│ │ • Handles HTTP communication                                               │ │
│ │ • Type-safe data models                                                    │ │
│ │ • Generated from OpenAPI spec                                              │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
         │
         │ Calls LDX-Sync API
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            LDX-Sync API                                        │
│                                                                                 │
│ Endpoint: /ldx_sync/config                                                     │
│ Version: 2024-10-15                                                            │
│ Parameters: remote_url (git remote URL)                                        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Flow Summary:

1. **Snyk Language Server** accesses configuration via framework: `c.Engine().GetConfiguration().Get(LDX_SYNC_CONFIG)`
2. **Default Functions** use both clients:
   - `DefaultFuncOrganizationLdx` → Both `LdxSyncConfigClient` + `api.ApiClient`
   - `DefaultFuncLdxSyncConfig` → `LdxSyncConfigClient` only
3. **Resolvers** use `LdxSyncConfigClient` for LDX-Sync operations
4. **`LdxSyncConfigClient`** internally uses generated OpenAPI client
5. **Generated client** calls the actual LDX-Sync API
6. **`api.ApiClient`** handles standard Snyk API operations for fallback scenarios

## Integration with Default Functions and Resolvers

### Default Functions

The LDX-Sync client integrates with the application framework's configuration system through default functions:

#### 1. Organization Resolution (`DefaultFuncOrganizationLdx`)

```go
func DefaultFuncOrganizationLdx(engine workflow.Engine, config configuration.Configuration, logger *zerolog.Logger, apiClientFactory func(url string, client *http.Client) api.ApiClient) configuration.DefaultValueFunction
```

**Client Usage:**
- **`LdxSyncConfigClient`** - For LDX-Sync configuration retrieval and organization resolution
- **`api.ApiClient`** - For standard organization operations (slug validation, default org lookup)

**Features:**
- Enhanced organization resolution using LDX-Sync
- Fallback to standard organization resolution
- Handles existing organization values (UUID validation, slug resolution)
- Uses hybrid approach: both clients for different purposes

#### 2. LDX-Sync Configuration (`DefaultFuncLdxSyncConfig`)

```go
func DefaultFuncLdxSyncConfig(engine workflow.Engine, config configuration.Configuration, logger *zerolog.Logger, apiClientFactory func(url string, client *http.Client) api.ApiClient) configuration.DefaultValueFunction
```

**Client Usage:**
- **`LdxSyncConfigClient`** - For all LDX-Sync configuration retrieval and processing

**Features:**
- Retrieves LDX-Sync configuration for the current project
- Caches configuration values
- Uses git remote URL for project identification
- Uses LDX-Sync client directly for better type safety

### Resolvers

#### Organization Resolution (`TryResolveOrganization`)

The resolver provides intelligent organization resolution:

**Client Usage:**
- **`LdxSyncConfigClient`** - For LDX-Sync configuration retrieval

**Process:**
1. **Git Repository Detection** - Finds the project root by walking up the directory tree
2. **Remote URL Extraction** - Gets the git remote URL using `git.GetRemoteUrl()`
3. **LDX-Sync API Call** - Calls `ldxClient.GetConfiguration()` with remote URL
4. **High-Level Resolution** - Uses `Configuration.Organization` directly from high-level config

#### Configuration Resolution (`GetConfig`)

Retrieves and transforms LDX-Sync configuration:

**Client Usage:**
- **`LdxSyncConfigClient`** - For all LDX-Sync configuration operations

**Process:**
1. **API Call** - Calls the LDX-Sync API with project context using `LdxSyncConfigClient`
2. **Direct Return** - Returns high-level `Configuration` struct directly
3. **No Conversion** - No manual data transformation needed

### Client Architecture

The LDX-Sync configuration system uses two distinct API clients:

#### **`LdxSyncConfigClient`** - Primary Client
```go
type LdxSyncConfigClient interface {
    GetConfiguration(ctx context.Context, params GetConfigurationParams) (*Configuration, error)
}
```

**Purpose:** For LDX-Sync configuration retrieval and organization resolution
**Implementation:**
- Uses generated OpenAPI client internally
- Provides high-level `Configuration` struct
- Handles all HTTP communication and data transformation
- Standalone client (not integrated into main `ApiClient` interface)

#### **`api.ApiClient`** - Fallback Client
```go
type ApiClient interface {
    GetOrgIdFromSlug(slugName string) (string, error)
    GetDefaultOrgId() (orgID string, err error)
    // ... other methods
}
```


## Usage Flow

1. **Configuration Request** - Application requests organization or configuration
2. **Default Function Execution** - Framework calls appropriate default function
3. **Git Context Detection** - Resolver finds project root and remote URL
4. **LDX-Sync Client Call** - Calls `ldxClient.GetConfiguration()` with remote URL
5. **Generated Client** - Uses auto-generated OpenAPI client internally
6. **High-Level Response** - Returns `Configuration` struct directly
7. **Caching** - Configuration is cached for subsequent requests
8. **Fallback Handling** - Falls back to standard organization resolution if LDX-Sync API is unavailable or returns no matching configuration


## Dependencies

- `github.com/oapi-codegen/oapi-codegen/v2` - OpenAPI code generation
- `github.com/golang/mock/mockgen` - Mock generation
- `github.com/rs/zerolog` - Structured logging
- `github.com/snyk/error-catalog-golang-public` - Error handling
